{"version":3,"file":"yodata-context.js","sources":["../src/constants.js","../src/parseContext.js","../src/context.js","../src/helpers/getIn.js","../src/helpers/defaultProps.js","../src/index.js"],"sourcesContent":["export const KEYMAP = 'cname';\nexport const VALMAP = 'cval';\n\nexport default {\n  KEYMAP,\n  VALMAP\n}\n","import { KEYMAP, VALMAP } from './constants'\nimport { get, isFunction, isNull, isPlainObject, isString, set, transform } from 'lodash'\n\nconst returnValue = props => props.value\n\nconst parseContext = contextDefinition => {\n  return transform(\n    contextDefinition,\n    (context, value, key) => {\n      const setKey = val => set(context, [ KEYMAP, key ], val);\n      const setVal = val => set(context, [ VALMAP, key ], val);\n\n      if (isNull(value)) {\n        setKey(value)\n        return context;\n      }\n      if (isString(value)) {\n        setKey(value)\n        return context;\n      }\n      if (isFunction(value)) {\n        setKey(key)\n        setVal(value)\n        return context;\n      }\n      // advanced context definition syntax\n      if (isPlainObject(value)) {\n        setKey(get(value, 'key', key))\n        setVal(get(value, 'val', returnValue))\n\n        if (value.context) {\n          // this hack will break if the subContext overwrites a key\n          // in the parent context.\n          // todo: implement subContext at JSON node level to avoid conflicts\n          let subContext = parseContext(value.context)\n          Object.assign(context[KEYMAP], subContext[KEYMAP])\n          Object.assign(context[VALMAP], subContext[VALMAP])\n        }\n        return context\n      }\n      // bad format\n      throw new Error('parseContext error')\n    },\n    {},\n  );\n};\n\nexport default parseContext\n","import get from 'lodash/get'\nimport transform from 'lodash/transform'\nimport { has, isNull, isPlainObject, set, curry } from 'lodash'\nimport { Set } from 'immutable'\nimport { KEYMAP, VALMAP } from './constants'\nimport parseContext from './parseContext'\n\nconst isArray = Array.isArray\n\nconst mapValueToContext = curry((context, value, key, last, props) => {\n  if (isArray(value)) {\n    let result = Set();\n    value.map(item => {\n      result = result.add(mapValueToContext(context, item, key, last, props));\n    });\n    return result.toArray();\n  }\n  if (isPlainObject(value)) {\n    let nextValue = context.map(value);\n    return context.hasVal(key)\n      ? context[ VALMAP ][ key ]({ value: nextValue, context, key, last, ...props })\n      : nextValue;\n  }\n  if (context.hasVal(value)) {\n    return context[ VALMAP ][ value ]({ context, value, key, last, ...props })\n  }\n  if (context.hasVal(key)) {\n    return context[ VALMAP ][ key ]({ context, value, key, last, ...props })\n  }\n  return context.mapKey(value)\n}, 2);\n\nconst withContext = context => (next, value, key, last) => {\n  let nextKey = context.mapKey(key)\n\n  if (isNull(nextKey)) {\n    return next\n  }\n\n  let nextValue = mapValueToContext(context, value, key, last);\n\n  // if next.nextKey has data, concat nextValue\n  if (has(next, nextKey)) {\n    nextValue = Set().concat(get(next, nextKey), nextValue).toArray()\n  }\n\n  return set(next, nextKey, nextValue)\n};\n\nexport default class Context {\n  constructor(cdef) {\n    this.cdef = {};\n    this.cname = {};\n    this.cval = {};\n    this.map = this.map.bind(this);\n    this.init(cdef);\n  }\n\n  init(cdef) {\n    Object.assign(this, parseContext(cdef));\n    this.cdef = cdef;\n  }\n\n  extend(cdef) {\n    return new Context({ ...this.cdef, ...cdef })\n  }\n\n  /**\n   * true if the current context mentions key\n   * @param {string} key\n   * @returns {boolean}\n   */\n  has(key) {\n    return has(this[ KEYMAP ], key) || has(this[ VALMAP ], key);\n  }\n\n  hasKey(key) {\n    return has(this[ KEYMAP ], key);\n  }\n\n  hasVal(key) {\n    return has(this[ VALMAP ], key);\n  }\n\n  mapKey(key) {\n    return get(this[ KEYMAP ], key, key);\n  }\n\n  mapVal(data) {\n    return mapValueToContext(this, data);\n  }\n\n  map(data, initialValue) {\n    let toContext = withContext(this);\n    let result = transform(data, toContext, initialValue);\n    return result;\n  }\n}\n","import get from 'lodash/get'\n\n/**\n * creates a deep getter with an optional default value\n * @param {string} path - the path to retrieve from the subject i.e. 'path.to.value'\n * @param {*} [defaultValue] - value to return if nothing is found at subject[path]\n */\nconst getIn = (path, defaultValue) => data => get(data, path, defaultValue)\n\nexport default getIn\n","import isPlainObject from 'lodash/isPlainObject';\n\nconst defaultProps = defaultProps => ({ value }) => {\n  if (isPlainObject(value)) {\n    return { ...defaultProps, ...value }\n  }\n  return value\n}\n\nexport default defaultProps\n","import Context from './context'\nimport {defaultProps, flow, getIn} from './helpers/index';\n\nexport default {\n  Context,\n  defaultProps,\n  flow,\n  getIn\n}\n"],"names":["KEYMAP","VALMAP","returnValue","props","value","parseContext","contextDefinition","transform","context","key","setKey","val","set","setVal","isNull","isString","isFunction","isPlainObject","get","subContext","assign","Error","isArray","Array","mapValueToContext","curry","last","result","Set","map","item","add","toArray","nextValue","hasVal","mapKey","withContext","next","nextKey","has","concat","Context","cdef","cname","cval","bind","init","data","initialValue","toContext","getIn","path","defaultValue","defaultProps"],"mappings":"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"}